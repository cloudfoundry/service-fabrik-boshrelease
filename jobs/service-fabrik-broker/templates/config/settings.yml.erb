<%
  def ostruct_to_hash(os)
    os.marshal_dump.map do |key, value|
      { key => value.is_a?(OpenStruct) ? ostruct_to_hash(value) : value }
    end.reduce(&:merge)
  end

  broker_name = p('name')
  log_path = "/var/vcap/sys/log/#{broker_name}/#{broker_name}.log"
  networks = ostruct_to_hash(spec.networks)
  default_ip = networks.values.find { |net| net.has_key?(:default) }[:ip]
  external = p('external')
  internal = p('internal')
%>---
production:
  ####################
  # GENERAL SETTINGS #
  ####################
  broker_name: '<%= broker_name %>'
  deployment_name: '<%= spec.deployment %>'
  username: '<%= p('username') %>'
  password: '<%= p('password') %>'
  skip_ssl_validation: <%= p('skip_ssl_validation') %>
  session_store:
    path: <%= "/var/vcap/store/#{broker_name}/session" %>
  log_path: <%= log_path %>
  log_level: <%= p('log_level') %>
  sys_log_level: <%= p('sys_log_level') %>
  enable_circuit_breaker: <%= p('enable_circuit_breaker') %>
  feature:
    ServiceInstanceAutoUpdate: <%= p('feature.ServiceInstanceAutoUpdate') %>
  http_timeout: <%= p('http_timeout') %>
  ##############################
  # EXTERNAL ENDPOINT SETTINGS #
  ##############################
  external:
    log_event: <%= p('external.log_event') %>
    event_type: SF.API_EVENT
    trust_proxy: <%= external['trust_proxy'] %>
    port: <%= external['port'] %>
    protocol: 'https'
    host: <%= external['host'] %>
    cookie_secret: <%= external['cookie_secret'] %>
    cookie_secure: true
    session_expiry: <%= external['session_expiry'] %>
    api_requires_admin_scope: <%= p('external.api_requires_admin_scope', false) %>

  ##############################
  # INTERNAL ENDPOINT SETTINGS #
  ##############################
  internal:
    log_event: <%= p('internal.log_event') %>
    event_type: SF.BROKER_EVENT
    domain_socket:
      path: <%= p('internal.domain_socket.path') %>
      fwd_events: true
    port: <%= internal['port'] %>
    ip: <%= internal['ip'] %>
    host: <%= "#{internal['ip']}:#{internal['port']}" %>
    <% if_p('internal.ssl') do |ssl| %>
    protocol: 'https'
    ssl: <%= JSON.dump(ssl) %>
    <% end.else do %>
    protocol: 'http'
    <% end %>

  ####################
  # MONGODB SETTINGS #
  ####################
  mongodb:
    <% if_p('mongodb.url') do |mongodb_url| %>
    url: <%= mongodb_url %>
    <% end %>
    <% if_p('mongodb.provision.plan_id') do |mongodb_plan_id| %>
    provision:
      plan_id: <%= mongodb_plan_id %>
      network_index: <%= p('mongodb.provision.network_index') %>
    <% end %>
    # Choice of integrating mongodb is either via an already provisioned mongo instance by specifying the URL OR
    # by specifying the plan id from service catalog, which fabrik will provision automatically and start using
    deployment_name: <%= p('mongodb.deployment_name') %>
    retry_connect:
      max_attempt: <%= p('mongodb.retry_connect.max_attempt') %>
      min_delay: <%= p('mongodb.retry_connect.min_delay') %>
    record_max_fetch_count: <%= p('mongodb.record_max_fetch_count') %>  # Max number of records that can be fetched at a time
    backup:
      schedule_interval: <%= p('mongodb.backup.schedule_interval') %>
    agent:
      provider:
        container: <%= p('mongodb.agent.provider.container') %>
      

  ######################
  # SCHEDULER SETTINGS #
  ######################
  scheduler:
    <% link("scheduler").if_p('job_types') do |job_types| %>
    job_types: <%= job_types %> # Comma seperated list of batch job types that are enabled in service fabrik
    <% end %>
    process_every: <%= link("scheduler").p('process_every') %> # Interval at which scheduler will query the database looking for jobs that need to be processed
    run_with_web_process: <%= link("scheduler").p('run_with_web_process') %> # Flag which indicates if scheduler can run in the same process as that of service fabrik broker web process
    max_concurrency: <%= link("scheduler").p('max_concurrency') %> # A number which specifies the max number of batch jobs that can be running at any given moment
    default_concurrency: <%= link("scheduler").p('default_concurrency') %> # A number which specifies the default number of a specific job that can be running at any given moment
    start_delay: <%= link("scheduler").p('start_delay') %>
    default_lock_lifetime: <%= link("scheduler").p('default_lock_lifetime') %> # Specifies the default lock lifetime of a batchjob in milliseconds.
    agenda_collection: <%= link("scheduler").p('agenda_collection') %> # Name of the collection in mongodb which is to be used by agendaJS to store the scheduled job meta info
    maintenance_check_interval:  <%= link("scheduler").p('maintenance_check_interval') %>
    maintenance_mode_time_out:  <%= link("scheduler").p('maintenance_mode_time_out') %>
    jobs:
      reschedule_delay: <%= link("scheduler").p('jobs.reschedule_delay') %>
      scheduled_backup:
        max_attempts: <%= link("scheduler").p('jobs.scheduled_backup.max_attempts') %>
      service_instance_update:
        max_attempts: <%= link("scheduler").p('jobs.service_instance_update.max_attempts') %>
        run_every_xdays:  <%= link("scheduler").p('jobs.service_instance_update.run_every_xdays') %>
        should_start_after_hr: <%= link("scheduler").p('jobs.service_instance_update.run_every_xdays') %>
        should_start_before_hr: <%= link("scheduler").p('jobs.service_instance_update.should_start_before_hr') %>
        should_start_after_min: <%= link("scheduler").p('jobs.service_instance_update.should_start_after_min') %>
        should_start_before_min: <%= link("scheduler").p('jobs.service_instance_update.should_start_before_min') %>
        time_zone: <%= link("scheduler").p('jobs.service_instance_update.time_zone') %>
    system_jobs:
      - name: 'service-fabrik-mongodb'
        type: 'ScheduledOobDeploymentBackup'
        interval: <%= p('mongodb.backup.schedule_interval') %> #Backup schedule interval for service fabrik DB
        job_data:
          type: 'online'
          trigger: 'scheduled'
          deployment_name: <%= p('mongodb.deployment_name') %>
          container: <%= p('mongodb.agent.provider.container') %>
      - name: 'Backup_Reaper'
        type: 'BackupReaper'
        interval: <%= link("scheduler").p('system_jobs.backup_reaper.interval') %> #Schedule interval for backup reaper job
        job_data:
          delete_delay: <%= link("scheduler").p('system_jobs.backup_reaper.job_data.delete_delay') %>
      - name: 'DbCollection_Reaper'
        type: 'DbCollectionReaper'
        interval:  <%= link("scheduler").p('system_jobs.dbcollection_reaper.interval') %> #Schedule interval for DB Collection reaper job
        job_data:
          reap_collections:
            - name : JobRunDetail
              retention_in_days:  <%= link("scheduler").p('system_jobs.dbcollection_reaper.jobrun_detail.retention_in_days') %>
            - name : EventDetail
              retention_in_days: <%= link("scheduler").p('system_jobs.dbcollection_reaper.event_detail.retention_in_days') %>
        enabled: true
      - name: 'MongoDB'
        type: 'ServiceFabrikBackup'
        interval: <%= p('mongodb.backup.schedule_interval') %>
        enabled: false

  #######################
  # MONITORING SETTINGS #
  #######################
  monitoring:
    success_state: 'ok'
    success_metric: 0
    failure_state: 'critical'
    failure_metric: 1
    warning_state: 'warning'
    inprogress_state: 'in progress'
    inprogress_metric: 2
    event_name_prefix: <%= p('riemann.prefix') %>.<%= name %>.<%= index %>.<%= spec.deployment %>
    include_response_body: <%= p('monitoring.include_response_body') %>
    events_logged_in_db: <%= p('monitoring.events_logged_in_db') %>
    unauthorized:
      http_status: [401,403]
      event_name: 'unauthorized_access'
      description: 'Unauthorized access to service attempted'
      tags: ['security', 'unauthorized']
      include_response_body: <%= p('monitoring.unauthorized.include_response_body') %>
  riemann:
    host: <%= p('riemann.host') %>
    port: <%= p('riemann.port') %>
    protocol : tcp
    show_errors: <%= p('riemann.show_errors') %>
    prefix: <%= p('riemann.prefix') %>
    log_additional_event: <%= p('riemann.log_additional_event') %>
    http_status_codes_to_be_skipped: <% p('riemann.http_status_codes_to_be_skipped').each do |code| %>
    - <%= code %><% end %>
    
  ###################
  # QUOTA MANAGEMENT SETTINGS #
  ###################
  quota: <%= JSON.dump(p('quota', nil)) %>

  ###################
  # BACKUP SETTINGS #
  ###################
  backup:
    retention_period_in_days: <%= p('backup.retention_period_in_days') %>
    max_num_on_demand_backup: <%= p('backup.max_num_on_demand_backup') %>
    status_check_every: <%= p('backup.status_check_every') %>
    retry_delay_on_error: <%= p('backup.retry_delay_on_error') %>
    lock_check_delay_on_restart: <%= p('backup.lock_check_delay_on_restart') %>
    backup_restore_status_poller_timeout: <%= p('backup.backup_restore_status_poller_timeout') %>
    backup_restore_status_check_every: <%= p('backup.backup_restore_status_check_every') %>
    abort_time_out: <%= p('backup.abort_time_out') %>
    max_allowed_no_backup_days_in_row: <%= p('backup.max_allowed_no_backup_days_in_row') %>
    provider: <%= JSON.dump(p('backup.provider', nil)) %>

  #################################
  # VIRTUAL HOST MANAGER SETTINGS #
  #################################
  virtual_host:
    provider: <%= JSON.dump(p('virtual_host.provider', nil)) %>

  #########################
  # CLOUDFOUNDRY SETTINGS #
  #########################
  cf:
    url: <%= p('cf.url') %>
    username: <%= p('cf.username') %>
    password: <%= p('cf.password') %>

  ###################
  # DOCKER SETTINGS #
  ###################
  docker:
    url: <%= p('docker.url') %>
    allocate_docker_host_ports: <%= p('docker.allocate_docker_host_ports') %>
    volume_driver: <%= p('docker.volume_driver') %>
    ssl:
      ca: <%= JSON.dump(p('common.tls_cacert')) %>
      cert: <%= JSON.dump(p('common.tls_client_cert')) %>
      key: <%= JSON.dump(p('common.tls_client_key')) %>

  #####################
  # DIRECTOR SETTINGS #
  #####################
  directors: <%= JSON.dump(p('directors')) %>
  ####################
  # SERVICES CATALOG #
  ####################
  services: <%= JSON.pretty_generate(p('services')) %>
